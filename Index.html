<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Green Care</title>
    
    <style>
        :root {
            --primary-color: #2e7d32; /* Main Green */
            --primary-hover: #1b5e20; /* Darker Green for Hover */
            --secondary-color: #4caf50; /* Lighter Green */
            --background-color: #f4f6f8; /* Soft Page Background */
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --danger-color: #d32f2f; /* Red for Delete/Cancel */
            --border-color: #e0e0e0; /* Light border color */
            --star-color: #FFC107; /* Gold for ratings */
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .hidden { display: none !important; }
        .full-page-loader { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: var(--primary-color); }
        .page-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .form-container { max-width: 600px; margin: 20px auto; padding: 25px; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); text-align: center; position: relative; }
        input, textarea, select { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary-color); outline: none; }
        .primary-button, .secondary-button, .danger-button { transition: all 0.2s ease-in-out; }
        .primary-button:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .secondary-button:hover { background-color: rgba(46, 125, 50, 0.1); transform: translateY(-2px); }
        .danger-button:hover { background-color: rgba(211, 47, 47, 0.1); transform: translateY(-2px); }
        .primary-button { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; }
        .secondary-button { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        .danger-button { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        .app-header { background-color: var(--card-bg); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .app-header h1 { color: var(--primary-color); font-size: 1.8rem; margin: 0; font-weight: 700; }
        .hero-section { background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1497990571654-77aa8ec36038?fit=crop&w=1200&q=80'); background-size: cover; background-position: center; color: white; padding: 80px 20px; text-align: center; border-radius: 0 0 20px 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 20px 20px; max-width: 1200px; margin: auto; }
        @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }
        .product-card { position: relative; background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); cursor: pointer; text-align: left; transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .item-list { text-align: left; margin-top: 20px; }
        .item-card { padding: 15px; background: #fafafa; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        .order-notes { background: #e9e9e9; border-radius: 5px; padding: 10px; margin-top: 10px; font-size: 0.9rem; }
        .status-Payment-Pending, .status-Shipped, .status-Delivered, .status-Payment-Confirmed, .status-Cancelled { font-weight: bold; }
        .status-Payment-Pending { color: #f57c00; } .status-Payment-Confirmed { color: #1976d2; } .status-Shipped { color: #388e3c; } .status-Delivered { color: #555; } .status-Cancelled { color: var(--danger-color); }
        .admin-dashboard .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); overflow-x: auto; }
        .admin-dashboard .tab-btn { padding: 15px 20px; cursor: pointer; background: none; border: none; font-size: 1rem; font-weight: bold; white-space: nowrap; border-bottom: 3px solid transparent; }
        .admin-dashboard .tab-btn.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); }
        .admin-dashboard .tab-content { display: none; } /* This hides inactive tabs */
        .admin-dashboard .tab-content.active { display: block; padding-top: 20px; } /* This shows the active tab */
        .admin-dashboard .table-wrapper { overflow-x: auto; }
        .admin-dashboard table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-dashboard th, .admin-dashboard td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; white-space: nowrap; }
        .admin-dashboard td.wrap-text { white-space: normal; }
        .whatsapp-fab { position: fixed; bottom: 25px; right: 25px; z-index: 100; /* ... other styles */ }
        .notification-bell { position: relative; cursor: pointer; font-size: 1.5rem; background: none; border: none; color: var(--primary-color); padding: 0 5px; }
        .notification-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid white; }
        
        /* Hamburger Menu Styles */
        .menu-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--primary-color); z-index: 1002; }
        .side-nav { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background-color: #fff; overflow-x: hidden; transition: 0.5s; padding-top: 60px; box-shadow: 3px 0 15px rgba(0,0,0,0.1); }
        .side-nav a { padding: 10px 15px 10px 32px; text-decoration: none; font-size: 1.2rem; color: #333; display: block; transition: 0.3s; }
        .side-nav a:hover { color: var(--primary-color); background-color: #f1f1f1;}
        .side-nav .close-btn { position: absolute; top: 15px; right: 25px; font-size: 36px; }
        .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }

        /* Filter Modal Styles */
        .filter-modal { position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        .filter-modal-content { background-color: #fefefe; padding: 25px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; }
        
        /* Payment Page Upload Area */
        #file-upload-label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; border: 2px dashed var(--border-color); border-radius: 8px; cursor: pointer; margin-bottom: 15px; background-color: #fafafa; transition: background-color 0.2s, border-color 0.2s; }
        #file-upload-label:hover { border-color: var(--primary-color); background-color: #f0f8f0; }

        /* Wishlist Heart Icon */
        .wishlist-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; z-index: 5; }
        .wishlist-btn.active { color: var(--danger-color); }

        /* Cart Icon */
        #cart-icon { position: relative; font-size: 1.5rem; color: var(--primary-color); cursor:pointer; }
        #cart-count { position: absolute; top: -5px; right: -10px; background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; font-weight: bold; border: 1px solid white; }
        
        /* Star Rating Styles */
        .star-rating { display: flex; align-items: center; gap: 4px; font-weight: bold; color: var(--text-color); }
        .star-rating .stars { color: var(--star-color); }
        .review-form .star-input { display: flex; flex-direction: row-reverse; justify-content: center; }
        .review-form .star-input input { display: none; }
        .review-form .star-input label { font-size: 2rem; color: #ccc; cursor: pointer; transition: color 0.2s; }
        .review-form .star-input input:checked ~ label,
        .review-form .star-input label:hover,
        .review-form .star-input label:hover ~ label { color: var(--star-color); }
    </style>
</head>
<body>
    <div id="app-root"></div>
    
    <a id="whatsapp-button" href="#" class="whatsapp-fab" target="_blank" rel="noopener noreferrer" title="Help on WhatsApp" style="width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.2);text-decoration:none;color:white;">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
    </a>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CLOUDINARY_CLOUD_NAME = "dosdxgao8"; const CLOUDINARY_UPLOAD_PRESET = "Your green care"; const YOUR_QR_CODE_URL = "https://i.imgur.com/YOUR_QR_CODE.png"; const YOUR_UPI_ID = "your-upi-id@okhdfcbank"; const YOUR_WHATSAPP_NUMBER = "919518460245"; const firebaseConfig = { apiKey: "AIzaSyCRnKk_qVvmSpw_t37kp5d3Si8Mgol0YHg", authDomain: "yourgreenapp.firebaseapp.com", projectId: "yourgreenapp", storageBucket: "yourgreenapp.firebasestorage.app", messagingSenderId: "205558339041", appId: "1:205558339041:web:ab6eb512c86f1e91c72ea0" };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore(); const root = document.getElementById('app-root'); const whatsappBtn = document.getElementById('whatsapp-button'); whatsappBtn.href = `https://wa.me/${YOUR_WHATSAPP_NUMBER}?text=${encodeURIComponent("I need help")}`;
        const appState = { user: null, userData: null, notifications: [], adminNotifications: [], products: [], categories: [], cart: [], currentPage: 'loading', pageData: null, };
        let notificationListener = null; let adminNotificationListener = null; let cartListener = null;

        async function fetchProducts() { try { const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get(); appState.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); appState.categories = ["All", ...new Set(appState.products.map(p => p.category))]; } catch (error) { console.error("Error fetching products:", error); appState.products = []; } }
        function setupNotificationListener(userId) { if (notificationListener) notificationListener(); notificationListener = db.collection('notifications').where('userId', '==', userId).orderBy('createdAt', 'desc').onSnapshot(querySnapshot => { appState.notifications = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateNotificationBellUI(); }); }
        function setupAdminNotificationListener() { if (adminNotificationListener) adminNotificationListener(); adminNotificationListener = db.collection('admin_notifications').orderBy('createdAt', 'desc').onSnapshot(querySnapshot => { appState.adminNotifications = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data()})); updateAdminNotificationBellUI(); }); }
        function setupCartListener(userId) { if(cartListener) cartListener(); cartListener = db.collection('users').doc(userId).collection('cart').onSnapshot(snapshot => { appState.cart = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateCartIconUI(); }); }

        function renderApp() {
            const { user, userData, currentPage } = appState;
            root.innerHTML = '';

            if (currentPage === 'loading') { root.innerHTML = `<div class="full-page-loader">Checking your account...</div>`; return; }
            if (!user) { root.appendChild(renderLoginPage(currentPage === 'signup')); return; }
            
            // SIGNUP FIX: If user is logged in but has no profile data, show ONLY the profile creation page.
            if (!userData) {
                root.appendChild(renderCreateProfilePage(user));
                return;
            }

            // This part now only runs if the user is logged in AND has profile data.
            root.appendChild(renderHeader());
            const pageContent = document.createElement('div');
            
            if (currentPage === 'home') pageContent.appendChild(renderHomePage());
            else if (currentPage === 'admin') pageContent.appendChild(displayAdminDashboard());
            else if (currentPage === 'productForm') pageContent.appendChild(renderProductForm(appState.pageData));
            else if (currentPage === 'editProfile') pageContent.appendChild(renderEditProfilePage(appState.pageData));
            else if (currentPage === 'adminNotifications') pageContent.appendChild(renderAdminNotificationsPage());
            else if (currentPage === 'productDetail') pageContent.appendChild(renderProductDetailPage(appState.pageData));
            else if (currentPage === 'payment') pageContent.appendChild(renderPaymentPage(appState.pageData));
            else if (currentPage === 'profile') pageContent.appendChild(displayProfilePage());
            else if (currentPage === 'notifications') pageContent.appendChild(renderNotificationsPage());
            else if (currentPage === 'wishlist') pageContent.appendChild(renderWishlistPage());
            else if (currentPage === 'cart') pageContent.appendChild(renderCartPage());
            else pageContent.appendChild(renderHomePage());
            
            root.appendChild(pageContent);
        }
        
        auth.onAuthStateChanged(async(user) => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                appState.user = user;
                if (userDoc.exists) {
                    appState.userData = userDoc.data();
                    if (!appState.userData.wishlist) appState.userData.wishlist = []; // Ensure wishlist exists
                    await fetchProducts();
                    if (appState.userData.isAdmin) { 
                        setupAdminNotificationListener(); 
                    } else { 
                        setupNotificationListener(user.uid); 
                        setupCartListener(user.uid); 
                    }
                    if (appState.currentPage === 'loading' || appState.currentPage === 'login' || appState.currentPage === 'signup') {
                        appState.currentPage = 'home';
                    }
                } else {
                    appState.currentPage = 'createProfile';
                    appState.userData = null;
                }
            } else {
                if (notificationListener) notificationListener();
                if (adminNotificationListener) adminNotificationListener();
                if (cartListener) cartListener();
                Object.assign(appState, { user: null, userData: null, notifications: [], adminNotifications: [], products: [], cart: [], currentPage: 'login' });
            }
            renderApp();
        });
        
        function navigate(page, data = null) { appState.currentPage = page; appState.pageData = data; window.scrollTo(0, 0); renderApp(); closeSideNav(); }
        function updateNotificationBellUI() { const bell = document.getElementById('notification-bell'); if (!bell) return; const hasUnread = appState.notifications.some(n => !n.isRead); const dot = bell.querySelector('.notification-dot'); if (hasUnread) { if (!dot) { const newDot = document.createElement('div'); newDot.className = 'notification-dot'; bell.appendChild(newDot); } } else { if (dot) dot.remove(); } }
        function updateAdminNotificationBellUI() { const bell = document.getElementById('admin-notification-bell'); if (!bell) return; const hasUnread = appState.adminNotifications.some(n => !n.isRead); const dot = bell.querySelector('.notification-dot'); if (hasUnread) { if (!dot) { const newDot = document.createElement('div'); newDot.className = 'notification-dot'; bell.appendChild(newDot); } } else { if (dot) dot.remove(); } }
        function updateCartIconUI() { const cartIcon = document.getElementById('cart-icon'); if (!cartIcon) return; let count = 0; appState.cart.forEach(item => { count += item.quantity; }); const countEl = cartIcon.querySelector('#cart-count'); if(count > 0) { if(countEl) { countEl.textContent = count; } else { const newCount = document.createElement('span'); newCount.id = 'cart-count'; newCount.textContent = count; cartIcon.appendChild(newCount); } } else { if(countEl) countEl.remove(); } }
        
        function openSideNav() { document.getElementById("side-nav").style.width = "250px"; document.getElementById("page-overlay").classList.remove('hidden'); }
        function closeSideNav() { const nav = document.getElementById("side-nav"); if(nav) nav.style.width = "0"; const overlay = document.getElementById("page-overlay"); if(overlay) overlay.classList.add('hidden'); }

        function renderHeader() { const headerContainer = document.createElement('div'); let navLinks = `<a href="javascript:void(0)" class="close-btn" onclick="closeSideNav()">&times;</a><a href="#" onclick="navigate('home')">Home</a>`; if (appState.userData.isAdmin) { navLinks += `<a href="#" onclick="navigate('admin')">Admin Panel</a>`; } else { navLinks += `<a href="#" onclick="navigate('profile')">My Profile</a><a href="#" onclick="navigate('wishlist')">My Wishlist</a>`; } navLinks += `<a href="#" onclick="auth.signOut()">Logout</a>`; headerContainer.innerHTML = `<div id="side-nav" class="side-nav">${navLinks}</div><div id="page-overlay" class="page-overlay hidden" onclick="closeSideNav()"></div><header class="app-header"><h1>Your Green Care</h1><div style="display: flex; align-items: center; gap: 15px;">${appState.userData.isAdmin ? `<button id="admin-notification-bell" class="notification-bell" title="Admin Notifications">🔔</button>` : `<div id="cart-icon" title="My Cart">🛒</div><button id="notification-bell" class="notification-bell" title="Notifications">🔔</button>`}<button class="menu-btn" onclick="openSideNav()">&#9776;</button></div></header>`; setTimeout(() => { updateNotificationBellUI(); updateAdminNotificationBellUI(); updateCartIconUI(); }, 100); const userBell = headerContainer.querySelector('#notification-bell'); const adminBell = headerContainer.querySelector('#admin-notification-bell'); const cartIcon = headerContainer.querySelector('#cart-icon'); if (userBell) userBell.onclick = () => navigate('notifications'); if (adminBell) adminBell.onclick = () => navigate('adminNotifications'); if (cartIcon) cartIcon.onclick = () => navigate('cart'); return headerContainer; }

        function renderLoginPage(isSigningUp) { const c = document.createElement('div'); const title = isSigningUp ? 'Create an Account' : 'Welcome'; const btnTxt = isSigningUp ? 'Sign Up' : 'Sign In'; const toggleTxt = isSigningUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up"; c.className = 'form-container'; c.innerHTML = `<h2>${title}</h2><form id="auth-form"><input type="email" id="email" placeholder="Email" required /><input type="password" id="password" placeholder="Password" required /><button type="submit" class="primary-button">${btnTxt}</button></form><button id="toggle-auth" style="background:none; border:none; color:var(--primary-color); cursor:pointer; margin-top:15px;">${toggleTxt}</button>`; c.querySelector('#toggle-auth').onclick = () => { appState.currentPage = isSigningUp ? 'login' : 'signup'; renderApp(); }; c.querySelector('#auth-form').addEventListener('submit', e => { e.preventDefault(); const email = c.querySelector('#email').value; const password = c.querySelector('#password').value; if (isSigningUp) auth.createUserWithEmailAndPassword(email, password).catch(err => alert('Sign Up Error: ' + err.message)); else auth.signInWithEmailAndPassword(email, password).catch(err => alert('Sign In Error: ' + err.message)); }); return c; }
        function renderCreateProfilePage(user) { const c = document.createElement('div'); c.className = 'form-container'; c.innerHTML = `<h2>Create Your Profile</h2><p>Welcome! Just a few more details.</p><input type="text" id="name" placeholder="Full Name" required/><input type="tel" id="phone" placeholder="10-digit mobile" required/><textarea id="address" placeholder="Full Address" required></textarea><button id="save-profile" class="primary-button">Save Profile</button>`; c.querySelector('#save-profile').onclick = async () => { const name = c.querySelector('#name').value; const address = c.querySelector('#address').value; const phone = c.querySelector('#phone').value; if (!name || !address || !phone) return alert('Please fill all fields'); const profile = { name, address, phone, email: user.email, isAdmin: false, wishlist: [], createdAt: new Date() }; try { await db.collection('users').doc(user.uid).set(profile); await db.collection('admin_notifications').add({ message: `New user signed up: ${name} (${user.email})`, isRead: false, createdAt: new Date() }); appState.userData = profile; navigate('home'); } catch (err) { alert("Error saving your profile."); } }; return c; }
        function renderHomePage() { const c = document.createElement('div'); const maxPrice = appState.products.length > 0 ? Math.ceil(Math.max(...appState.products.map(p => p.price)) / 100) * 100 : 1000; let filters = { category: 'All', subcategory: 'All', price: maxPrice, search: '' }; c.innerHTML = `<div class="hero-section"><h2>Nurture Your Green Dreams</h2><p>Find the perfect home for your plants.</p></div><div style="padding:20px;max-width:500px;margin: -40px auto 0 auto;"><input type="search" id="search-bar" placeholder="Search products..." style="width: calc(100% - 30px); padding: 15px; border-radius: 25px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-size: 1rem;"/></div><div style="text-align:center; padding-bottom: 20px;"><button id="show-filters-btn" class="primary-button" style="width: auto;">Show Filters</button></div><div id="filter-modal" class="filter-modal hidden"><div class="filter-modal-content"><h3>Filters</h3><label>Category</label><select id="filter-category"></select><label>Subcategory</label><select id="filter-subcategory"></select><label for="price-slider">Max Price: <span id="price-value">₹${maxPrice}</span></label><input type="range" id="price-slider" min="0" max="${maxPrice}" value="${maxPrice}" style="width:100%;" /><button id="apply-filters-btn" class="primary-button" style="margin-top: 20px;">Apply Filters</button><button id="close-modal-btn" class="secondary-button" style="margin-top: 10px;">Close</button></div></div><div class="product-grid" id="product-grid"></div>`; const pGrid = c.querySelector('#product-grid'), modal = c.querySelector('#filter-modal'), catSelect = c.querySelector('#filter-category'), subcatSelect = c.querySelector('#filter-subcategory'), priceSlider = c.querySelector('#price-slider'), priceValue = c.querySelector('#price-value'); function render() { const f = appState.products.filter(p => (filters.category==='All'||p.category===filters.category) && (filters.subcategory==='All'||p.subcategory===filters.subcategory) && p.price<=filters.price && p.name.toLowerCase().includes(filters.search)); const wishlist = appState.userData.wishlist || []; pGrid.innerHTML = f.map(p => `<div class="product-card" data-productid="${p.id}"><button class="wishlist-btn ${wishlist.includes(p.id)?'active':''}" onclick="event.stopPropagation(); window.toggleWishlist('${p.id}')">❤</button><img src="${p.imageUrl}" alt="${p.name}" style="width:100%;height:160px;object-fit:cover;border-radius:8px;"><h3 style="margin:10px 0 5px;font-size:1rem;">${p.name}</h3>${p.averageRating ? `<div class="star-rating"><span class="stars">★</span> ${p.averageRating.toFixed(1)} (${p.reviewCount || 0})</div>` : ''}<p style="font-weight:bold;color:var(--primary-color);font-size:1.1rem;">₹${p.price}</p></div>`).join(''); pGrid.querySelectorAll('.product-card').forEach(card => card.onclick = () => navigate('productDetail', card.dataset.productid)); } function popFilters() { catSelect.innerHTML = appState.categories.map(c => `<option value="${c}">${c}</option>`).join(''); catSelect.value = filters.category; popSubcats(); priceSlider.value = filters.price; priceValue.textContent = `₹${filters.price}`; } function popSubcats() { const cat = catSelect.value; if (cat === 'All') { subcatSelect.innerHTML = '<option value="All">All</option>'; subcatSelect.disabled = true; } else { const subcats = ['All', ...new Set(appState.products.filter(p => p.category === cat).map(p => p.subcategory).filter(Boolean))]; subcatSelect.innerHTML = subcats.map(sc => `<option value="${sc}">${sc}</option>`).join(''); subcatSelect.disabled = false; } subcatSelect.value = 'All'; } c.querySelector('#search-bar').oninput = e => { filters.search = e.target.value.toLowerCase(); render(); }; c.querySelector('#show-filters-btn').onclick = () => { popFilters(); modal.classList.remove('hidden'); }; c.querySelector('#close-modal-btn').onclick = () => modal.classList.add('hidden'); modal.onclick = e => { if (e.target === modal) modal.classList.add('hidden'); }; catSelect.onchange = popSubcats; priceSlider.oninput = () => priceValue.textContent = `₹${priceSlider.value}`; c.querySelector('#apply-filters-btn').onclick = () => { filters.category = catSelect.value; filters.subcategory = subcatSelect.value; filters.price = Number(priceSlider.value); modal.classList.add('hidden'); render(); }; render(); return c; }
        function renderProductDetailPage(productId) { const p = appState.products.find(p => p.id === productId); if (!p) { const el = document.createElement('div'); el.className = 'form-container'; el.innerHTML = '<h2>Product not found</h2>'; return el; } const c = document.createElement('div'); c.className = 'form-container'; const isWished = appState.userData.wishlist.includes(p.id); c.innerHTML = `<button onclick="navigate('home')" class="secondary-button" style="position: absolute; top: 20px; left: 20px; z-index: 2;">Back</button><button class="wishlist-btn ${isWished?'active':''}" style="top: 20px; right: 20px; z-index: 2;" onclick="window.toggleWishlist('${p.id}')">❤</button><img src="${p.imageUrl}" style="width:100%; max-width:400px; border-radius:8px; margin-top: 40px;"><h2 style="margin: 15px 0;">${p.name}</h2>${p.averageRating ? `<div class="star-rating" style="justify-content:center;font-size:1.2rem;margin-bottom:10px;"><span class="stars">★</span> ${p.averageRating.toFixed(1)} <span style="font-size:1rem;color:#777;">(${p.reviewCount || 0} reviews)</span></div>` : '<p>No reviews yet.</p>'}<p style="font-size:1.5rem; color:var(--primary-color); font-weight:bold;">₹${p.price}</p><p style="text-align:left; padding: 0 10px;">${p.description}</p><div style="display:flex;gap:10px;margin-top:15px;"><button id="add-to-cart" class="secondary-button" style="flex:1;">Add to Cart</button><button id="buy-now" class="primary-button" style="flex:1;">Buy Now</button></div><hr style="margin: 25px 0;" /><div id="reviews-section"><h3>Reviews</h3><div id="reviews-list">Loading reviews...</div><div id="review-form-container" class="hidden"></div></div>`; c.querySelector('#buy-now').onclick = () => navigate('payment', { items: [{...p, quantity: 1 }], total: p.price }); c.querySelector('#add-to-cart').onclick = () => window.addToCart(p.id); (async () => { const reviewsList = c.querySelector('#reviews-list'); const reviewFormContainer = c.querySelector('#review-form-container'); try { const snapshot = await db.collection('reviews').where('productId', '==', productId).orderBy('createdAt', 'desc').get(); const reviews = snapshot.docs.map(d => d.data()); if (reviews.length > 0) { reviewsList.innerHTML = reviews.map(r => `<div class="item-card"><div class="star-rating">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</div><p>${r.reviewText}</p><small><strong>${r.userName}</strong> on ${new Date(r.createdAt.toDate()).toLocaleDateString()}</small></div>`).join(''); } else { reviewsList.innerHTML = '<p>No reviews for this product yet.</p>'; } const orderSnap = await db.collection('orders').where('userId', '==', appState.user.uid).where('productId', '==', productId).where('status', '==', 'Delivered').get(); if (!orderSnap.empty) { reviewFormContainer.classList.remove('hidden'); reviewFormContainer.innerHTML = `<h4>Write a Review</h4><form class="review-form"><div class="star-input"><input type="radio" name="rating" id="star5" value="5" /><label for="star5">☆</label><input type="radio" name="rating" id="star4" value="4" /><label for="star4">☆</label><input type="radio" name="rating" id="star3" value="3" /><label for="star3">☆</label><input type="radio" name="rating" id="star2" value="2" /><label for="star2">☆</label><input type="radio" name="rating" id="star1" value="1" /><label for="star1">☆</label></div><textarea id="review-text" placeholder="Share your thoughts..." required></textarea><button type="submit" class="primary-button">Submit Review</button></form>`; reviewFormContainer.querySelector('form').onsubmit = (e) => { e.preventDefault(); const rating = e.target.rating.value; const reviewText = e.target['review-text'].value; if (!rating || !reviewText) return alert('Please provide a rating and a review.'); window.submitReview(productId, Number(rating), reviewText); }; } } catch(err){ reviewsList.innerHTML = '<p>Could not load reviews.</p>'; console.error(err); } })(); return c; }
        function renderPaymentPage(paymentData) { const { items, total } = paymentData; const isSingleItem = items.length === 1; const c = document.createElement('div'); c.className = 'form-container'; const backNav = () => isSingleItem ? navigate('productDetail', items[0].id) : navigate('cart'); c.innerHTML = `<button onclick="(${backNav})()" class="secondary-button" style="position: absolute; top: 20px; left: 20px; z-index: 2;">Back</button><h2 style="margin-top: 40px;">Complete Payment</h2><div class="item-card" style="text-align:left;"><h4>Order Summary</h4>${items.map(p => `<p><strong>Product:</strong> ${p.name} (x${p.quantity})</p>`).join('')}<p><strong>Amount to Pay:</strong> ₹${total}</p></div><hr style="margin: 20px 0;" /><div style="text-align:center;"><h4>Scan & Pay</h4><img src="${YOUR_QR_CODE_URL}" alt="QR Code" style="max-width:200px; border-radius: 8px;"/><p><strong>UPI ID:</strong> ${YOUR_UPI_ID}</p></div><hr style="margin: 20px 0;" /><h4>Confirm Your Payment</h4><p>After paying, please upload the screenshot and enter the UTR.</p><input type="text" id="utr" placeholder="Enter 12-Digit UTR" required/><label id="file-upload-label" for="screenshot"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg><span style="margin-top: 10px;">Click to Upload Screenshot</span></label><input type="file" id="screenshot" accept="image/*" class="hidden"/><p id="file-name" style="color: #555; font-weight: bold;">No file selected.</p><button id="confirm-order" class="primary-button">I've Paid, Confirm Order</button>`; const btn = c.querySelector('#confirm-order'); c.querySelector('#screenshot').onchange = () => { c.querySelector('#file-name').textContent = c.querySelector('#screenshot').files.length > 0 ? `Selected: ${c.querySelector('#screenshot').files[0].name}` : 'No file selected.'; }; btn.onclick = async () => { const utr = c.querySelector('#utr').value; const file = c.querySelector('#screenshot').files[0]; if (!/^\d{12}$/.test(utr)) return alert('Enter a valid 12-digit UTR.'); if (!file) return alert('Upload a screenshot.'); btn.disabled = true; btn.textContent = 'Uploading...'; try { const form = new FormData(); form.append('file', file); form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: form }); const data = await res.json(); if (!data.secure_url) throw new Error('Upload failed.'); const batch = db.batch(); items.forEach(product => { const orderRef = db.collection('orders').doc(); batch.set(orderRef, { userId: auth.currentUser.uid, userName: appState.userData.name, userEmail: appState.userData.email, shippingAddress: appState.userData.address, productId: product.id, productName: product.name, price: product.price, quantity: product.quantity, orderDate: new Date(), status: 'Payment-Pending', utr, screenshotUrl: data.secure_url, statusHistory: [] }); }); await batch.commit(); await db.collection('admin_notifications').add({ message: `New order of ${items.length} items (₹${total}) from ${appState.userData.name}`, isRead: false, createdAt: new Date() }); if (!isSingleItem) { const cartBatch = db.batch(); appState.cart.forEach(item => { const itemRef = db.collection('users').doc(auth.currentUser.uid).collection('cart').doc(item.id); cartBatch.delete(itemRef); }); await cartBatch.commit(); } alert('Order Placed!'); navigate('profile'); } catch (err) { alert('Could not place order.'); btn.disabled = false; btn.textContent = 'I\'ve Paid, Confirm Order'; } }; return c; }
        function renderNotificationsPage() { const c = document.createElement('div'); c.className = 'form-container'; c.innerHTML = `<button onclick="navigate('home')" class="secondary-button" style="float: right;">Home</button> <h2>Notifications</h2> <div class="item-list" style="clear: both;"></div>`; const l = c.querySelector('.item-list'); if (appState.notifications.length === 0) { l.innerHTML = '<p>No notifications.</p>'; } else { l.innerHTML = appState.notifications.map(n => `<div class="item-card" style="background:${n.isRead?'#fafafa':'#e8f5e9'};"><p>${n.message}</p><p style="font-size:0.8rem;color:#555;text-align:right;">${new Date(n.createdAt.toDate()).toLocaleString()}</p></div>`).join(''); const unread=appState.notifications.filter(n=>!n.isRead); if(unread.length>0){const b=db.batch(); unread.forEach(n=>{b.update(db.collection('notifications').doc(n.id),{isRead:true});}); b.commit().catch(console.error);} } return c;}
        function renderAdminNotificationsPage() { const c = document.createElement('div'); c.className = 'form-container'; c.innerHTML = `<button onclick="navigate('admin')" class="secondary-button" style="float: right;">Admin</button> <h2>Admin Notifications</h2> <div class="item-list" style="clear: both;"></div>`; const l = c.querySelector('.item-list'); if (appState.adminNotifications.length === 0) { l.innerHTML = '<p>No notifications.</p>'; } else { l.innerHTML = appState.adminNotifications.map(n => `<div class="item-card" style="background:${n.isRead?'#fafafa':'#e8f5e9'};"><p>${n.message}</p><p style="font-size:0.8rem;color:#555;text-align:right;">${new Date(n.createdAt.toDate()).toLocaleString()}</p></div>`).join(''); const unread=appState.adminNotifications.filter(n=>!n.isRead); if(unread.length>0){const b=db.batch(); unread.forEach(n=>{b.update(db.collection('admin_notifications').doc(n.id),{isRead:true});}); b.commit().catch(console.error);} } return c;}
        function renderEditProfilePage(userIdToEdit) { const isSelf= !userIdToEdit || userIdToEdit===auth.currentUser.uid; const targetId=isSelf?auth.currentUser.uid:userIdToEdit; const c=document.createElement('div'); c.className='form-container'; c.innerHTML=`<div class="full-page-loader">Loading...</div>`; db.collection('users').doc(targetId).get().then(doc=>{if(!doc.exists){c.innerHTML=`<p>User not found.</p>`;return;} const user=doc.data();c.innerHTML=`<h2>Edit Profile</h2><input id="name" value="${user.name}"/><textarea id="address">${user.address}</textarea><input id="phone" value="${user.phone}"/><button id="save" class="primary-button">Save</button><button id="cancel" class="secondary-button" style="margin-top:10px;">Cancel</button>`; c.querySelector('#save').onclick=async()=>{const data={name:c.querySelector('#name').value,address:c.querySelector('#address').value,phone:c.querySelector('#phone').value}; await db.collection('users').doc(targetId).update(data); alert('Updated!'); if(isSelf){appState.userData={...appState.userData,...data};navigate('profile');}else{navigate('admin');}}; c.querySelector('#cancel').onclick=()=>isSelf?navigate('profile'):navigate('admin');}); return c;}
        function displayProfilePage() { const c = document.createElement('div'); c.innerHTML = `<div class="full-page-loader">Loading...</div>`; (async () => { try { const query = await db.collection('orders').where('userId', '==', auth.currentUser.uid).orderBy('orderDate', 'desc').get(); const orders = query.docs.map(doc => ({ id: doc.id, ...doc.data() })); c.className = 'form-container'; let ordersHtml = orders.length === 0 ? '<p>No orders.</p>' : orders.map(o => { const canCancel = o.status === 'Payment-Pending' || o.status === 'Payment-Confirmed'; const notesHtml = o.statusHistory && o.statusHistory.length > 0 ? `<div class="order-notes"><strong>Admin Notes:</strong><br>${o.statusHistory.map(h => `<span>- ${h.reason} <em>(${new Date(h.timestamp.toDate()).toLocaleDateString()})</em></span>`).join('<br>')}</div>` : ''; return `<div class="item-card"><p><strong>Product:</strong> ${o.productName}</p><p><strong>Price:</strong> ₹${o.price}</p><p><strong>Status:</strong> <span class="status-${o.status.replace(/ /g, '-')}">${o.status}</span></p>${o.utr ? `<p><small>UTR: ${o.utr}</small></p>` : ''}${notesHtml}${canCancel ? `<button class="danger-button" style="margin-top:10px; width:100%;" onclick="window.cancelOrder('${o.id}')">Cancel Order</button>` : ''}</div>`; }).join(''); c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h3 style="margin:0;">Details</h3><div><button onclick="navigate('editProfile')" class="secondary-button" style="margin-right:5px;">Edit</button><button onclick="navigate('home')" class="secondary-button">Home</button></div></div><div style="text-align:left;clear:both;"><p><strong>Name:</strong> ${appState.userData.name}</p><p><strong>Address:</strong> ${appState.userData.address}</p><p><strong>Email:</strong> ${appState.userData.email}</p><p><strong>Phone:</strong> ${appState.userData.phone}</p></div><hr/><h3>My Orders</h3><div class="item-list">${ordersHtml}</div>`; } catch (err) { console.error("Error fetching profile: ", err); c.innerHTML = `<p>Could not load profile.</p>`; }})(); return c;}
        function renderWishlistPage() { const c = document.createElement('div'); c.className = 'page-container'; const wishlist = appState.userData.wishlist || []; if (wishlist.length === 0) { c.innerHTML = `<div class="form-container"><h2>My Wishlist</h2><p>You haven't added any products to your wishlist yet.</p><button class="primary-button" style="width:auto;" onclick="navigate('home')">Explore Products</button></div>`; return c; } const wishlistedProducts = appState.products.filter(p => wishlist.includes(p.id)); c.innerHTML = `<div class="form-container" style="max-width: 1200px;"><h2>My Wishlist</h2></div><div class="product-grid">${wishlistedProducts.map(p => `<div class="product-card" data-productid="${p.id}"><button class="wishlist-btn active" onclick="event.stopPropagation(); window.toggleWishlist('${p.id}')">❤</button><img src="${p.imageUrl}" alt="${p.name}" style="width:100%;height:160px;object-fit:cover;border-radius:8px;"><h3 style="margin:10px 0 5px;font-size:1rem;">${p.name}</h3><p style="font-weight:bold;color:var(--primary-color);font-size:1.1rem;">₹${p.price}</p></div>`).join('')}</div>`; c.querySelectorAll('.product-card').forEach(card => card.onclick = () => navigate('productDetail', card.dataset.productid)); return c; }
        function renderCartPage() { const c = document.createElement('div'); c.className = 'form-container'; if (appState.cart.length === 0) { c.innerHTML = `<h2>My Cart</h2><p>Your cart is empty.</p><button class="primary-button" style="width:auto;" onclick="navigate('home')">Start Shopping</button>`; return c; } let subtotal = 0; const cartItemsHtml = appState.cart.map(item => { subtotal += item.price * item.quantity; return `<div class="item-card" style="display:flex; align-items:center; gap:15px;"><img src="${item.imageUrl}" alt="${item.name}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;"/><div style="flex:1;"><p><strong>${item.name}</strong></p><p>₹${item.price}</p></div><div style="text-align:right;"><input type="number" value="${item.quantity}" min="1" onchange="window.updateCartQuantity('${item.id}', this.value)" style="width: 60px; text-align:center; margin-bottom: 5px;"/><button class="danger-button" onclick="window.removeFromCart('${item.id}')">Remove</button></div></div>`; }).join(''); c.innerHTML = `<h2>My Cart</h2><div class="item-list">${cartItemsHtml}</div><hr/><div style="text-align:right; font-size:1.2rem; font-weight:bold; margin: 20px 0;"><p>Subtotal: ₹${subtotal.toFixed(2)}</p></div><button id="checkout-btn" class="primary-button">Proceed to Checkout</button>`; c.querySelector('#checkout-btn').onclick = () => { const paymentData = { items: appState.cart.map(item => ({...appState.products.find(p => p.id === item.productId), id: item.productId, quantity: item.quantity })), total: subtotal }; navigate('payment', paymentData); }; return c; }
        
        function displayAdminDashboard() { const container = document.createElement('div'); container.className = 'page-container admin-dashboard'; container.innerHTML = `<div class="full-page-loader">Loading Dashboard...</div>`; (async () => { try { const [usersSnap, ordersSnap, productsSnap] = await Promise.all([ db.collection('users').orderBy('createdAt', 'desc').get(), db.collection('orders').orderBy('orderDate', 'desc').get(), db.collection('products').orderBy('createdAt', 'desc').get() ]); const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); const allOrders = ordersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); const products = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); container.innerHTML = `<h2>Admin Dashboard</h2><div class="tab-nav"> <button class="tab-btn active" data-tab="orders">Orders</button> <button class="tab-btn" data-tab="users">Users</button> <button class="tab-btn" data-tab="products">Products</button> </div><div id="orders-tab" class="tab-content active"><div class="filter-controls" style="display:flex; flex-wrap:wrap; gap:5px;"> <button class="category-btn active" data-status="All">All (${allOrders.length})</button> <button class="category-btn" data-status="Payment-Pending">Pending (${allOrders.filter(o=>o.status==='Payment-Pending').length})</button> <button class="category-btn" data-status="Payment-Confirmed">Confirmed (${allOrders.filter(o=>o.status==='Payment-Confirmed').length})</button> <button class="category-btn" data-status="Shipped">Shipped (${allOrders.filter(o=>o.status==='Shipped').length})</button> <button class="category-btn" data-status="Delivered">Delivered (${allOrders.filter(o=>o.status==='Delivered').length})</button> <button class="category-btn" data-status="Cancelled">Cancelled (${allOrders.filter(o=>o.status==='Cancelled').length})</button> </div><div class="table-wrapper"><table id="orders-table"><thead><tr><th>Customer</th><th>Product</th><th>UTR</th><th>Screenshot</th><th>Status</th><th>Actions</th></tr></thead><tbody id="orders-tbody"></tbody></table></div></div><div id="users-tab" class="tab-content"><div class="table-wrapper"><table><thead><tr><th>Name</th><th>Email</th><th>Actions</th></tr></thead><tbody>${users.map(u => `<tr><td class="wrap-text">${u.name}</td><td>${u.email} ${u.isAdmin?'<strong>(A)</strong>':''}</td><td><div style="display:flex; flex-direction:column; gap:5px;"><button class="secondary-button" onclick="window.sendAdminMessage('${u.id}')">Message</button><button class="secondary-button" onclick="window.editUserByAdmin('${u.id}')">Edit</button><button class="danger-button" onclick="window.deleteUser('${u.id}', '${u.name}')">Delete</button></div></td></tr>`).join('')}</tbody></table></div></div><div id="products-tab" class="tab-content"><button class="primary-button" onclick="navigate('productForm')" style="width: auto; margin-bottom: 20px;">Add New Product</button><div class="table-wrapper"><table><thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Category</th><th>Subcategory</th><th>Actions</th></tr></thead><tbody>${products.map(p => `<tr><td><img src="${p.imageUrl}" alt="${p.name}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;"/></td><td class="wrap-text">${p.name}</td><td>₹${p.price}</td><td>${p.category}</td><td>${p.subcategory || ''}</td><td><div style="display:flex; flex-direction:column; gap:5px;"><button class="secondary-button" onclick="window.editProduct('${p.id}')">Edit</button><button class="danger-button" onclick="window.deleteProduct('${p.id}', '${p.name}')">Delete</button></div></td></tr>`).join('')}</tbody></table></div></div>`; const renderOrders = (filter) => { const filtered = filter === 'All' ? allOrders : allOrders.filter(o => o.status === filter); const tbody = container.querySelector('#orders-tbody'); tbody.innerHTML = filtered.map(o => `<tr><td class="wrap-text">${o.userName}<br><small>${o.userEmail}</small></td><td class="wrap-text">${o.productName} (₹${o.price})</td><td>${o.utr||'N/A'}</td><td><a href="${o.screenshotUrl}" target="_blank">View</a></td><td><select id="status-${o.id}" onchange="window.updateOrderStatus('${o.id}','${o.userId}')">${['Payment-Pending','Payment-Confirmed','Shipped','Delivered', 'Cancelled'].map(s=>`<option value="${s}" ${o.status===s?'selected':''}>${s.replace('-',' ')}</option>`).join('')}</select></td><td><button class="danger-button" onclick="window.cancelOrderByAdmin('${o.id}', '${o.userId}')">Cancel</button></td></tr>`).join(''); }; container.querySelectorAll('#orders-tab .filter-controls .category-btn').forEach(btn => { btn.onclick = () => { container.querySelector('#orders-tab .filter-controls .active').classList.remove('active'); btn.classList.add('active'); renderOrders(btn.dataset.status); }; }); renderOrders('All'); container.querySelectorAll('.tab-nav .tab-btn').forEach(btn => { btn.onclick = () => { container.querySelector('.tab-nav .active').classList.remove('active'); container.querySelector('.tab-content.active').classList.remove('active'); btn.classList.add('active'); container.querySelector(`#${btn.dataset.tab}-tab`).classList.add('active'); }; }); } catch (err) { console.error("Error fetching admin data: ", err); container.innerHTML = `<p>Could not load dashboard.</p>`; }})(); return container; }
        function renderProductForm(productId = null) { const c = document.createElement('div'); c.className = 'form-container'; const showForm = (p={}) => { c.innerHTML = `<h2>${productId?'Edit':'Add'} Product</h2><input id="name" placeholder="Name" value="${p.name||''}"/><textarea id="description" placeholder="Description">${p.description||''}</textarea><input id="price" type="number" placeholder="Price" value="${p.price||''}"/><input id="category" placeholder="Category (e.g., Pots)" value="${p.category||''}"/><input id="subcategory" placeholder="Subcategory (e.g., Ceramic)" value="${p.subcategory||''}"/><label id="file-upload-label" for="image">Upload Image</label><input type="file" id="image" accept="image/*" class="hidden"/><p id="file-name">No file selected</p><img id="preview" src="${p.imageUrl||''}" style="max-width:100px;display:${p.imageUrl?'block':'none'};margin:0 auto 15px;"/><button id="save" class="primary-button">Save</button><button id="cancel" class="secondary-button" style="margin-top:10px;">Cancel</button>`; const saveBtn = c.querySelector('#save'), fileInput = c.querySelector('#image'); fileInput.onchange = () => { if (fileInput.files.length>0) { c.querySelector('#file-name').textContent = fileInput.files[0].name; const reader = new FileReader(); reader.onload = e => { c.querySelector('#preview').src = e.target.result; c.querySelector('#preview').style.display = 'block'; }; reader.readAsDataURL(fileInput.files[0]); } }; c.querySelector('#cancel').onclick = () => navigate('admin'); saveBtn.onclick = async () => { const data = { name: c.querySelector('#name').value, description: c.querySelector('#description').value, price: Number(c.querySelector('#price').value), category: c.querySelector('#category').value, subcategory: c.querySelector('#subcategory').value }; if (!data.name||!data.price||!data.category) { return alert('Fill name, price, and category'); } saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; try { let imageUrl = c.querySelector('#preview').src; if (fileInput.files[0]) { const form = new FormData(); form.append('file', fileInput.files[0]); form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: form }); const d = await res.json(); imageUrl = d.secure_url; } data.imageUrl = imageUrl; if (productId) { await db.collection('products').doc(productId).update(data); } else { data.createdAt = new Date(); data.averageRating = 0; data.reviewCount = 0; await db.collection('products').add(data); } alert('Saved!'); navigate('admin'); } catch (err) { alert('Failed.'); saveBtn.disabled = false; saveBtn.textContent = 'Save'; } }; }; if(productId){db.collection('products').doc(productId).get().then(doc=>doc.exists?showForm(doc.data()):(alert("Not found!"),navigate('admin'))); } else { showForm();} return c; }

        window.toggleWishlist = async (productId) => { const userRef = db.collection('users').doc(auth.currentUser.uid); let currentWishlist = appState.userData.wishlist || []; if (currentWishlist.includes(productId)) { currentWishlist = currentWishlist.filter(id => id !== productId); } else { currentWishlist.push(productId); } await userRef.update({ wishlist: currentWishlist }); appState.userData.wishlist = currentWishlist; renderApp(); };
        window.addToCart = async (productId) => { const product = appState.products.find(p => p.id === productId); const cartRef = db.collection('users').doc(auth.currentUser.uid).collection('cart'); const existingItem = appState.cart.find(item => item.productId === productId); if (existingItem) { await cartRef.doc(existingItem.id).update({ quantity: existingItem.quantity + 1 }); } else { await cartRef.add({ productId: product.id, name: product.name, price: product.price, imageUrl: product.imageUrl, quantity: 1 }); } alert(`${product.name} added to cart!`); };
        window.updateCartQuantity = async (cartItemId, quantity) => { const newQuantity = Number(quantity); if (newQuantity < 1) return; await db.collection('users').doc(auth.currentUser.uid).collection('cart').doc(cartItemId).update({ quantity: newQuantity }); };
        window.removeFromCart = async (cartItemId) => { if (confirm('Remove this item from your cart?')) { await db.collection('users').doc(auth.currentUser.uid).collection('cart').doc(cartItemId).delete(); } };
        window.submitReview = async (productId, rating, reviewText) => { const reviewData = { productId, userId: auth.currentUser.uid, userName: appState.userData.name, rating, reviewText, createdAt: new Date() }; try { await db.collection('reviews').add(reviewData); const productRef = db.collection('products').doc(productId); await db.runTransaction(async (transaction) => { const productDoc = await transaction.get(productRef); if (!productDoc.exists) { throw "Product does not exist!"; } const oldReviewCount = productDoc.data().reviewCount || 0; const oldAverageRating = productDoc.data().averageRating || 0; const newReviewCount = oldReviewCount + 1; const newAverageRating = ((oldAverageRating * oldReviewCount) + rating) / newReviewCount; transaction.update(productRef, { reviewCount: newReviewCount, averageRating: newAverageRating }); }); alert('Review submitted!'); await fetchProducts(); navigate('productDetail', productId); } catch (err) { alert('Failed to submit review.'); console.error(err); } };
        window.sendAdminMessage = async (uid) => { const msg = prompt("Message:"); if (msg && msg.trim()) { try { await db.collection('notifications').add({ userId: uid, message: msg.trim(), isRead: false, createdAt: new Date() }); alert('Sent!'); } catch(err) { alert('Failed.'); } } };
        window.editUserByAdmin = (uid) => navigate('editProfile', uid);
        window.deleteUser = async (userId, userName) => { if(confirm(`DELETE user "${userName}"? This cannot be undone.`)){ try { await db.collection('users').doc(userId).delete(); await db.collection('admin_notifications').add({ message: `User ${userName} deleted.`, isRead: false, createdAt: new Date() }); alert('User deleted.'); renderApp(); } catch(err) { alert('Failed to delete user.'); } } };
        window.updateOrderStatus = async (orderId, userId) => { const newStatus = document.getElementById(`status-${orderId}`).value; const reason = prompt(`Reason for changing status to "${newStatus}" (optional, will be sent to user):`); if(reason === null) { document.getElementById(`status-${orderId}`).value = appState.orders.find(o=>o.id === orderId).status; return; } const historyEntry = { status: newStatus, reason: reason || 'Status updated by admin.', timestamp: new Date() }; try { await db.collection('orders').doc(orderId).update({ status: newStatus, statusHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry) }); await db.collection('notifications').add({ userId, message: `Order status is now: ${newStatus}. ${reason ? 'Note: '+reason : ''}`, createdAt: new Date(), isRead: false }); alert('Status updated & user notified!'); renderApp(); } catch (err) { alert('Failed to update.'); } };
        window.cancelOrderByAdmin = async (orderId, userId) => { if (confirm('Cancel this order?')) { const reason = prompt("Reason for cancellation (sent to user):"); if (reason === null) return; const historyEntry = { status: 'Cancelled', reason: reason || 'Order cancelled by admin.', timestamp: new Date() }; try { await db.collection('orders').doc(orderId).update({ status: 'Cancelled', statusHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry) }); await db.collection('notifications').add({ userId, message: `Your order was cancelled. Note: ${reason || 'Cancelled by admin.'}`, createdAt: new Date(), isRead: false }); alert('Order cancelled & user notified!'); renderApp(); } catch (err) { alert('Failed to cancel.'); } } };
        window.cancelOrder = async (orderId) => { if (confirm('Are you sure you want to cancel this order?')) { try { await db.collection('orders').doc(orderId).update({ status: 'Cancelled' }); await db.collection('admin_notifications').add({ message: `User ${appState.userData.name} cancelled order (...${orderId.slice(-6)}).`, isRead: false, createdAt: new Date() }); alert('Order cancelled.'); renderApp(); } catch (err) { alert('Could not cancel.'); } } };
        window.editProduct = (pid) => navigate('productForm', pid);
        window.deleteProduct = async (pid, name) => { if (confirm(`Delete "${name}"?`)) { try { await db.collection('products').doc(pid).delete(); await db.collection('admin_notifications').add({ message: `Product "${name}" was deleted.`, isRead: false, createdAt: new Date() }); alert('Deleted!'); renderApp(); } catch (err) { alert('Failed.'); } } };
        
        renderApp();
    </script>
</body>
</html>
